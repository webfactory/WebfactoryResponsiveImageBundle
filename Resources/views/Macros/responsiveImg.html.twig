{# Responsive Image #}
{% macro responsiveImg(entity, nameOfImageAccessor, imgOptions) %}
    {% if attribute(entity, nameOfImageAccessor) and attribute(attribute(entity, nameOfImageAccessor), 'download') %}
        {% import _self as helper %}

        {% set defaultImgOptions = {
            sizes: '100%',
            widths: {'image_xxs' : '320w'},
            placeholderFilter: 'image_xxs--blurred',
            class: '',
            altText: '',
            lazyload: true,
        } %}
        {% set imgOptions = imgOptions ? defaultImgOptions|merge(imgOptions) : defaultImgOptions %}

        <img
            {{ helper.sizes(imgOptions.sizes, imgOptions.lazyload) }}
            {{ helper.srcset(entity, nameOfImageAccessor, imgOptions.widths, imgOptions.lazyload) }}

            src="{{ thumbor(cachable_s3_url(entity, nameOfImageAccessor), imgOptions.placeholderFilter) }}"
            class="{% if imgOptions.lazyload %}lazyload {% endif %}{{ imgOptions.class }}"

            {% if attribute(attribute(entity, nameOfImageAccessor), 'credits') is defined and attribute(entity, nameOfImageAccessor).credits|length > 0 %}
                title="&copy; {{ attribute(entity, nameOfImageAccessor).credits }}"
            {% endif %}
        />

        <noscript>
            <img
                src="{{ thumbor(cachable_s3_url(entity, nameOfImageAccessor), imgOptions.widths|keys|first) }}"
                class="{{ imgOptions.class }}"
                alt="{{ imgOptions.altText }}"
                {% if attribute(attribute(entity, nameOfImageAccessor), 'credits') is defined and attribute(entity, nameOfImageAccessor).credits|length > 0 %}
                    title="&copy; {{ attribute(entity, nameOfImageAccessor).credits }}"
                {% endif %}
            />
        </noscript>
    {% endif %}
{% endmacro %}

{# Responsive Image with art direction #}
{% macro responsivePicture(variants, picOptions) %}
    {% import _self as helper %}

    {% set defaultPicOptions = {
        class: '',
        altText: '',
        lazyload: true,
        placeholderFilter: 'image_xxs--blurred',
    } %}

    {% set defaultImgOptions = {
        sizes: '100vw',
        widths: {'image_xxs' : '320w'},
        query: '',
    } %}

    <picture>
        {% set picOptions = picOptions ? defaultPicOptions|merge(picOptions) : defaultPicOptions %}

        {% for variant in variants %}
            {% set entity, nameOfImageAccessor, imgOptions = variant.0, variant.1, variant.2 %}
            {% set imgOptions = imgOptions ? defaultImgOptions|merge(imgOptions) : defaultImgOptions %}

            {% if attribute(entity, nameOfImageAccessor) and attribute(attribute(entity, nameOfImageAccessor), 'download') %}
                <source
                    media="{{ imgOptions.query }}"
                    {{ helper.sizes(imgOptions.sizes, picOptions.lazyload) }}
                    {{ helper.srcset(entity, nameOfImageAccessor, imgOptions.widths, picOptions.lazyload) }}
                />
            {% endif %}
        {% endfor %}

        {% set entity, nameOfImageAccessor = variants.0[0], variants.0[1] %}
        {% if attribute(entity, nameOfImageAccessor) and attribute(attribute(entity, nameOfImageAccessor), 'download') %}
            <img
                src="{{ thumbor(cachable_s3_url(entity, nameOfImageAccessor), picOptions.placeholderFilter) }}"
                class="{% if picOptions.lazyload %}lazyload {% endif %}{{ picOptions.class }}"
                alt="{{ picOptions.altText }}"
                {% if attribute(attribute(entity, nameOfImageAccessor), 'credits') is defined and attribute(entity, nameOfImageAccessor).credits|length > 0 %}
                    title="&copy; {{ attribute(entity, nameOfImageAccessor).credits }}"
                {% endif %}
            />
        {% endif %}
    </picture>
{% endmacro %}

{# Helper: returns sizes-attribute #}
{% macro sizes(sizes, lazyload) %}
    {% if lazyload %}
        data-sizes="auto"
    {% else %}
        sizes="
        {%- if sizes is iterable -%}
            {%- for key, size in sizes -%}
                {%- if not loop.last -%}
                    ({{ key }}) {{ size }},
                {%- else -%}
                    {{ size }}
                {%- endif -%}
            {%- endfor -%}
        {%- else -%}
            {{ sizes|default('100%') }}
        {%- endif -%}"
    {% endif %}
{% endmacro %}

{# Helper: returns srcset-attribute #}
{% macro srcset(entity, nameOfImageAccessor, widths, lazyload) %}
    {% if lazyload %}data-{% endif %}srcset="
    {%- for key, width in widths -%}
        {{ thumbor(cachable_s3_url(entity, nameOfImageAccessor), key) }} {{ width }}
        {%- if not loop.last -%},{%- endif -%}
    {%- endfor -%}"
{% endmacro %}
